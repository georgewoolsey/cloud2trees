<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Creating DTM and CHM rasters • cloud2trees</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Creating DTM and CHM rasters">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cloud2trees</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/cloud2trees-setup.html">Setup</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Overview</h6></li>
    <li><a class="dropdown-item" href="../articles/cloud2trees-overview.html">Overview</a></li>
    <li><a class="dropdown-item" href="../articles/cloud2trees-pipeline.html">cloud2trees Pipeline</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Tutorials</h6></li>
    <li><a class="dropdown-item" href="../articles/cloud2raster-tutorial.html">Creating DTM and CHM rasters</a></li>
    <li><a class="dropdown-item" href="../articles/raster2trees-tutorial.html">Generating a tree list from a CHM</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/georgewoolsey/cloud2trees/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Creating DTM and CHM rasters</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/georgewoolsey/cloud2trees/blob/main/vignettes/articles/cloud2raster-tutorial.Rmd" class="external-link"><code>vignettes/articles/cloud2raster-tutorial.Rmd</code></a></small>
      <div class="d-none name"><code>cloud2raster-tutorial.Rmd</code></div>
    </div>

    
    
<p>The cloud2trees package was designed so that complex point cloud
processing could be run progressively, allowing users to achieve
specific tasks in the overall workflow of generating tree-level forest
inventory attributes. The first critical task in this process is
generating the foundational raster products: the Digital Terrain Model
(DTM) and the Canopy Height Model (CHM), which are considered
first-order derivatives coming directly from the point cloud. This
tutorial focuses on the dedicated <code><a href="../reference/cloud2raster.html">cloud2raster()</a></code> function,
which efficiently packages all the essential, customizable steps for
surface generation. For users seeking end-to-end processing, these same
parameters are also accessible through the main
<code><a href="../reference/cloud2trees.html">cloud2trees()</a></code> function which is <a href="cloud2trees-pipeline.html">demonstrated here</a>.</p>
<p>The <code><a href="../reference/cloud2raster.html">cloud2raster()</a></code> function executes a defined sequence
of operations, beginning with tiling the point cloud to manage memory
(if necessary). This is followed by sequential operations, including
ground classification and outlier removal, leading to DTM creation via
ground point triangulation and rasterization. Height normalization of
the point cloud and subsequent creation of the CHM based on the highest
point per pixel. The process concludes with pit and spike filling and
smoothing of the final raster. Understanding and customizing these
parameters grants fine-grained influence over surface generation, with
the CHM directly influencing the reliability of subsequent Individual
Tree Detection (ITD) steps.</p>
<p>Let’s load the libraries we’ll use</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://georgewoolsey.github.io/cloud2trees/">cloud2trees</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="extract-raster-data-from-point-cloud-defaults">Extract Raster Data from Point Cloud: Defaults<a class="anchor" aria-label="anchor" href="#extract-raster-data-from-point-cloud-defaults"></a>
</h2>
<p>We’ll begin by using a small point cloud dataset that ships with the
<code>lidR</code> package for processing (we previously used this data
in the package <a href="cloud2trees-overview.html">overview
demonstration</a>. The <code><a href="../reference/cloud2raster.html">cloud2raster()</a></code> function requires the
<code>input_las_dir</code> argument to be the path to a single point
cloud file (<em>.las</em> or <em>.laz</em>) or a directory containing
these files. If a directory is utilized, the function treats the
directory and all sub-directories as a single point cloud catalog,
processing all contained files together. Therefore, ensure that the
specified directory contains only the point cloud data intended for a
single processing area, as the function recursively processes all files
within its path.</p>
<p>We also need to define where outputs should be written in the
<code>output_dir</code> argument. For demonstration we’ll use a
temporary directory but you’ll likely want to point to a permanent
directory, for example: <em>C:/Data/MixedConifer</em>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># the path to a single .las|.laz file </span></span>
<span><span class="co">#  -or- the directory to a folder with many .las|.laz files</span></span>
<span><span class="va">las_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"lidR"</span>, <span class="st">"extdata"</span>, <span class="st">"MixedConifer.laz"</span><span class="op">)</span></span>
<span><span class="co"># output directroy</span></span>
<span><span class="va">out_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>First, we’ll run <code><a href="../reference/cloud2raster.html">cloud2raster()</a></code> with all of the default
settings</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cloud2raster_ans</span> <span class="op">&lt;-</span> <span class="fu">cloud2trees</span><span class="fu">::</span><span class="fu"><a href="../reference/cloud2raster.html">cloud2raster</a></span><span class="op">(</span></span>
<span>  input_las_dir <span class="op">=</span> <span class="va">las_dir</span></span>
<span>  , output_dir <span class="op">=</span> <span class="va">out_dir</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>You will see a progress bar giving updates about what the process is
doing.</p>
<p>Now, let’s explore what <code><a href="../reference/cloud2raster.html">cloud2raster()</a></code> created</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cloud2raster_ans</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "dtm_rast"                     "chm_rast"                    </span></span>
<span><span class="co">#&gt; [3] "create_project_structure_ans" "chunk_las_catalog_ans"       </span></span>
<span><span class="co">#&gt; [5] "normalize_flist"</span></span></code></pre></div>
<p>The above command should show you a list of five objects that the
output contains. The <code>dtm_rast</code> and <code>chm_rast</code>
contain the main raster outputs, but some users might care about the
other three objects. The <code>normalize_flist</code> contains a list of
the height normalized point cloud tiles,
<code>chunk_las_catalog_ans</code> is a ggplot object for creating a
plot that displays the dataset’s tiles, and the
<code>create_project_structure_ans</code> is a table listing all of the
data source locations and output file locations.</p>
<p><code><a href="../reference/cloud2raster.html">cloud2raster()</a></code> also wrote data to the disk at the
location defined in the <code>output_dir</code> argument for use outside
of the current working session. The process creates a sub-folder
containing the outputs which is always titled
<em>point_cloud_processing_delivery</em>. If you run this process
multiple times using the same <code>output_dir</code> location, then
everything in the <em>point_cloud_processing_delivery</em> directory
will be overwritten. As such, if you intend to perform multiple
iterations of the processing in the same <code>output_dir</code>
location it is recommended you rename the
<em>point_cloud_processing_delivery</em> directory before running the
next iteration.</p>
<p>Let’s see what was written to the disk.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">"point_cloud_processing_delivery"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "chm_0.25m.tif"         "dtm_1m.tif"            "raw_las_ctg_info.gpkg"</span></span></code></pre></div>
<p>There is a <em>.tif</em> file for both the DTM and CHM raster which
includes the resolution of the data in the file name.</p>
<p>There is also a <em>raw_las_ctg_info.gpkg</em> file which includes
the processing extent covered by the point cloud data as a spatial
polygon. This data can be used to ensure the point cloud covered your
intended area of interest or to calculate area-based metrics by properly
representing the area covered by the data. This spatial extent is the
same as the <code>chunk_las_catalog_ans$process_data</code> return from
the <code><a href="../reference/cloud2raster.html">cloud2raster()</a></code> function.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">"point_cloud_processing_delivery"</span>, <span class="st">"raw_las_ctg_info.gpkg"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span>quiet <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"navy"</span>, lwd <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">cloud2raster_ans</span><span class="op">$</span><span class="va">chunk_las_catalog_ans</span><span class="op">$</span><span class="va">process_data</span></span>
<span>    , fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"gold"</span>, lwd <span class="op">=</span> <span class="fl">1.3</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_light</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="cloud2raster-tutorial_files/figure-html/unnamed-chunk-7-1.png" width="100%"></p>
<p>Let’s look at the digital terrain model (DTM) raster</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># there's a DTM</span></span>
<span><span class="va">cloud2raster_ans</span><span class="op">$</span><span class="va">dtm_rast</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; size        : 90, 90, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 1, 1  (x, y)</span></span>
<span><span class="co">#&gt; extent      : 481260, 481350, 3812921, 3813011  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : NAD83 / UTM zone 12N (EPSG:26912) </span></span>
<span><span class="co">#&gt; source      : dtm_1m.tif </span></span>
<span><span class="co">#&gt; name        : 1_dtm_1m </span></span>
<span><span class="co">#&gt; min value   : 0.000000 </span></span>
<span><span class="co">#&gt; max value   : 0.622001</span></span></code></pre></div>
<p>The DTM was created at the <code><a href="../reference/cloud2raster.html">cloud2raster()</a></code> default 1 m
resolution and that the elevations vary between 0.00 and 0.62 m.</p>
<p>we can plot the DTM using <code><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">terra::plot()</a></code></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">cloud2raster_ans</span><span class="op">$</span><span class="va">dtm_rast</span><span class="op">)</span></span></code></pre></div>
<p><img src="cloud2raster-tutorial_files/figure-html/unnamed-chunk-9-1.png" width="100%"></p>
<p>While the plot shows a fair amount of variation, let’s remember it
only represents 0.62 m of vertical relief. If we looked at an area with
60 m of vertical relief, for example, we would not even notice these
small fluctuations.</p>
<p>There is also a canopy height model (CHM) raster</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># there's a CHM</span></span>
<span><span class="va">cloud2raster_ans</span><span class="op">$</span><span class="va">chm_rast</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; size        : 360, 360, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 0.25, 0.25  (x, y)</span></span>
<span><span class="co">#&gt; extent      : 481260, 481350, 3812921, 3813011  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : NAD83 / UTM zone 12N (EPSG:26912) </span></span>
<span><span class="co">#&gt; source      : chm_0.25m.tif </span></span>
<span><span class="co">#&gt; name        : focal_mean </span></span>
<span><span class="co">#&gt; min value   :       2.01 </span></span>
<span><span class="co">#&gt; max value   :      32.02</span></span></code></pre></div>
<p>The CHM was created at the <code><a href="../reference/cloud2raster.html">cloud2raster()</a></code> default 0.25 m
resolution and that the elevations vary between 2.01 and 32.02 m.</p>
<p>we can plot the CHM using <code><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">terra::plot()</a></code></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">cloud2raster_ans</span><span class="op">$</span><span class="va">chm_rast</span>, col <span class="op">=</span> <span class="fu">grDevices</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">heat.colors</a></span><span class="op">(</span><span class="fl">55</span>, alpha <span class="op">=</span> <span class="fl">0.88</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="cloud2raster-tutorial_files/figure-html/unnamed-chunk-11-1.png" width="100%"></p>
<p>We can also plot this raster data using the <code>ggplot2</code>
package which provides a vast collection of customization for plotting.
Here, we’ll use a different color palette than we used with
<code><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">terra::plot()</a></code> above to demonstrate, but the same
<code><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">grDevices::heat.colors</a></code> color palette could be used if
desired.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cloud2raster_ans</span><span class="op">$</span><span class="va">chm_rast</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span>xy<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>f<span class="op">=</span><span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span></span>
<span>    mapping <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>, y<span class="op">=</span><span class="va">y</span>, fill<span class="op">=</span><span class="va">f</span><span class="op">)</span></span>
<span>    , alpha <span class="op">=</span> <span class="fl">0.9</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"plasma"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"X"</span>, y <span class="op">=</span> <span class="st">"Y"</span>, fill <span class="op">=</span> <span class="st">"CHM (m)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_light</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"top"</span></span>
<span>    , axis.text <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="cloud2raster-tutorial_files/figure-html/unnamed-chunk-12-1.png" width="100%"></p>
<p>If we really like this figure and want to share it, we can write it
out to an image file</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">out_dir</span>,<span class="st">"MixedConifer_chm_025m.jpg"</span><span class="op">)</span></span>
<span>  , dpi <span class="op">=</span> <span class="fl">300</span></span>
<span>  , height <span class="op">=</span> <span class="fl">5</span>, width <span class="op">=</span> <span class="fl">6</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="customizing-dtm-generation">Customizing DTM Generation<a class="anchor" aria-label="anchor" href="#customizing-dtm-generation"></a>
</h2>
<p>The <code><a href="../reference/cloud2raster.html">cloud2raster()</a></code> function offers two key arguments
that influence the DTM’s role in the pipeline and the quality of the
final raster products. The straightforward argument is
<code>dtm_res_m</code>, which controls the final output resolution of
the rasterized DTM. The second argument, <code>accuracy_level</code>,
requires more context. In processing the point cloud,
<code><a href="../reference/cloud2raster.html">cloud2raster()</a></code> always first generates continuous DTM by
creating a Delaunay triangulation (or “meshed DTM”) of the ground
classified points. This continuous model and the separate rasterized DTM
are both generated independent of the <code>accuracy_level</code>
setting.</p>
<p>The <code>accuracy_level</code> argument does not affect DTM
creation, it determines which DTM product is used to height-normalize
the non-ground points for subsequent CHM generation. If
<code>accuracy_level</code> is set to ‘1’, the DTM at the resolution
defined by the <code>dtm_res_m</code> argument is used for
normalization, meaning the chosen <code>dtm_res_m</code> will impact the
final CHM quality. However, if <code>accuracy_level</code> is set to ‘2’
or ‘3’, the higher-fidelity triangulated DTM is used for normalization,
and the <code>dtm_res_m</code> setting has no impact on the CHM quality.
Using higher values (‘2’ or ‘3’) for the <code>accuracy_level</code>
argument results in longer processing times, however testing has shown
limited differences in the CHM output between level ‘2’ and ‘3’.</p>
<p>We will create DTM at 2 m and 0.5 m resolutions and look at the
differences</p>
<p>First, the 2 m DTM</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 2 m dtm</span></span>
<span><span class="va">cloud2raster_ans_dtm_2m</span> <span class="op">&lt;-</span> <span class="fu">cloud2trees</span><span class="fu">::</span><span class="fu"><a href="../reference/cloud2raster.html">cloud2raster</a></span><span class="op">(</span></span>
<span>  input_las_dir <span class="op">=</span> <span class="va">las_dir</span></span>
<span>  , output_dir <span class="op">=</span> <span class="va">out_dir</span></span>
<span>  , dtm_res_m <span class="op">=</span> <span class="fl">2.0</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can confirm that we got the resolution expected by checking the
resolution in the X and Y horizontal</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 2 m dtm</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>  <span class="st">"The resolution of `cloud2raster_ans_dtm_2m` is: "</span></span>
<span>  , <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">res</a></span><span class="op">(</span><span class="va">cloud2raster_ans_dtm_2m</span><span class="op">$</span><span class="va">dtm_rast</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "The resolution of `cloud2raster_ans_dtm_2m` is: 2x2"</span></span></code></pre></div>
<p>Let’s plot the DTM raster and store it. We won’t show it here as
we’ll combine later using <code>patchwork</code></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plt_dtm_2m</span></span>
<span><span class="va">plt_dtm_2m</span> <span class="op">&lt;-</span> <span class="va">cloud2raster_ans_dtm_2m</span><span class="op">$</span><span class="va">dtm_rast</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span>xy<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>f<span class="op">=</span><span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span></span>
<span>    mapping <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>, y<span class="op">=</span><span class="va">y</span>, fill<span class="op">=</span><span class="va">f</span><span class="op">)</span></span>
<span>    , alpha <span class="op">=</span> <span class="fl">0.9</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"viridis"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"Elevation (m)"</span>, title <span class="op">=</span> <span class="st">"DTM - 2.0 m resolution"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_light</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"none"</span></span>
<span>    , axis.text <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>    , axis.title <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    , plot.title <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Second, the 0.5 m DTM</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 0.5 m dtm</span></span>
<span><span class="va">cloud2raster_ans_dtm_0.5m</span> <span class="op">&lt;-</span> <span class="fu">cloud2trees</span><span class="fu">::</span><span class="fu"><a href="../reference/cloud2raster.html">cloud2raster</a></span><span class="op">(</span></span>
<span>  input_las_dir <span class="op">=</span> <span class="va">las_dir</span></span>
<span>  , output_dir <span class="op">=</span> <span class="va">out_dir</span></span>
<span>  , dtm_res_m <span class="op">=</span> <span class="fl">0.5</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can confirm that we got the resolution expected by checking the
resolution in the X and Y horizontal</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 0.5 m dtm</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>  <span class="st">"The resolution of `cloud2raster_ans_dtm_0.5m` is: "</span></span>
<span>  , <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">res</a></span><span class="op">(</span><span class="va">cloud2raster_ans_dtm_0.5m</span><span class="op">$</span><span class="va">dtm_rast</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "The resolution of `cloud2raster_ans_dtm_0.5m` is: 0.5x0.5"</span></span></code></pre></div>
<p>Let’s plot the DTM raster and store it. We won’t show it here as
we’ll combine later using <code>patchwork</code></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plt_dtm_0.5m</span></span>
<span><span class="va">plt_dtm_0.5m</span> <span class="op">&lt;-</span> <span class="va">cloud2raster_ans_dtm_0.5m</span><span class="op">$</span><span class="va">dtm_rast</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span>xy<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>f<span class="op">=</span><span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span></span>
<span>    mapping <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>, y<span class="op">=</span><span class="va">y</span>, fill<span class="op">=</span><span class="va">f</span><span class="op">)</span></span>
<span>    , alpha <span class="op">=</span> <span class="fl">0.9</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"viridis"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"Elevation (m)"</span>, title <span class="op">=</span> <span class="st">"DTM - 0.5 m resolution"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_light</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"none"</span></span>
<span>    , axis.text <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>    , axis.title <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    , plot.title <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>combine with <code><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html" class="external-link">patchwork::wrap_plots()</a></code></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># patchwork</span></span>
<span><span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html" class="external-link">wrap_plots</a></span><span class="op">(</span><span class="va">plt_dtm_2m</span>, <span class="va">plt_dtm_0.5m</span><span class="op">)</span></span></code></pre></div>
<p><img src="cloud2raster-tutorial_files/figure-html/unnamed-chunk-20-1.png" width="100%"></p>
<p>Visually it seems that the 0.5 m resolution has a smoother appearance
than the 2.0 m resolution, but it is important to consider the
trade-offs as the 0.5 m resolution data contains 16 times as much
data.</p>
<p>To maximize flexibility and avoid repeating the computationally
expensive point cloud processing (a significant issue, especially for
broad-extent data), we strongly advise generating the DTM at the finest
resolution needed (i.e. smaller <code>dtm_res_m</code> setting).
However, do not set the resolution finer than your analysis requires, as
generating and storing unnecessarily high-resolution data wastes both
time and disk space. It is far more efficient to later aggregate a fine
resolution raster than it is to re-run the entire pipeline. For
instance, you can take a fine 0.5 m resolution raster and aggregate it
to a more coarse 2.0 m resolution.</p>
<p>Here is how to create a coarser, 2.0 m resolution raster from the 0.5
m resolution raster using <code><a href="https://rspatial.github.io/terra/reference/aggregate.html" class="external-link">terra::aggregate()</a></code> and we’ll
display the resultant resolution in the X and Y horizontal</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span></span>
<span>    <span class="va">cloud2raster_ans_dtm_0.5m</span><span class="op">$</span><span class="va">dtm_rast</span></span>
<span>    , fact <span class="op">=</span> <span class="fl">4</span></span>
<span>    , fun <span class="op">=</span> <span class="st">"max"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">res</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span>collapse <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2x2"</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by George Woolsey.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
